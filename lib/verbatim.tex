%% TeXBook page 375
{\catcode `\`=\active \gdef`{\relax\lq}}
\def\uncatcodespecials{\def\do##1{\catcode`##1=12 }\dospecials}
\newcount\lineno % the number of file lines listed
\def\setupverbatim{\tt \lineno=0
  \def\par{\leavevmode\endgraf} \catcode`\`=\active
  \obeylines \uncatcodespecials \obeyspaces
  \everypar{\advance\lineno by1 \llap{\sevenrm\the\lineno\ \ }}}
{\obeyspaces\global\let =\ } % let active space = control space
\def\listing#1{\par\begingroup\setupverbatim\input#1 \endgroup}

\def\verbatim{\begingroup\setupverbatim\doverbatim}
\def\doverbatim#1{\def\next##1#1{##1\endgroup}\next}

